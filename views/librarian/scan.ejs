<%- include('../partials/header') %>
<div class="container my-5 text-center">
  <h1 class="mb-4">Librarian QR Scanner</h1>
  <div id="reader" style="width: 500px; margin: auto;"></div>
  <div id="result" class="mt-3"></div>
</div>

<!-- Include html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  // Called when a QR code is successfully scanned.
  function onScanSuccess(decodedText, decodedResult) {
    // Stop scanning on successful read.
    html5QrcodeScanner.clear().then(_ => {
      // Send the decoded token to the /verify endpoint.
      fetch('/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: decodedText })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success){
          document.getElementById('result').innerHTML =
            '<div class="alert alert-success">Student Verified: ' +
            data.student.studentID + ' - ' + data.student.email + '</div>';
        } else {
          document.getElementById('result').innerHTML =
            '<div class="alert alert-danger">Verification Failed: ' + data.message + '</div>';
        }
      })
      .catch(err => {
        document.getElementById('result').innerHTML =
          '<div class="alert alert-danger">Error: ' + err.message + '</div>';
      });
    }).catch(err => {
      console.error('Failed to clear scanner.', err);
    });
  }

  // Called on scanning failure, logs failure if needed.
  function onScanFailure(error) {
    console.warn('QR Code scan error:', error);
  }

  // Create and render the scanner.
  let html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", { fps: 10, qrbox: 250 }, false
  );
  html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
<%- include('../partials/footer') %>
